name: nuget-build-test-deploy
on:
  push:
    branches:
      - master

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: Junetic.Common
      OWNER: ${{ github.repository_owner }}
    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 6.0.x

      - name: Check out Code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Determine semantic version
        id: version
        uses: PaulHatch/semantic-version@v4.0.2
        with:
          branch: master
          tag_prefix: "v"
          major_pattern: /^feat(\(\w+\)?(?=!:\s))?(?<breaking>!).*/
          minor_pattern: /^feat(\(\w+\)?((?=:\s))).*/
          format: "${major}.${minor}.${patch}"
          change_path: "src/Junetic.Common"
          search_commit_body: true

      - name: Restore dependencies
        run: dotnet restore

      - name: Build dotnet
        run: dotnet build ${{ env.PROJECT_NAME }}.sln --configuration release /p:Version=${{ steps.version.outputs.version }} --no-restore


      - name: Run Tests
        run: dotnet test ${{ env.PROJECT_NAME }}.sln --configuration Release /p:Version=${{ steps.version.outputs.version }} --no-build --verbosity normal

      - name: Package nuget
        run: dotnet pack ${{ env.PROJECT_NAME }}.sln --configuration release -o:package /p:PackageVersion=${{ steps.version.outputs.version }}

      - name: Push generated package to GitHub registry
        run: dotnet nuget push ./package/*.nupkg  --source "https://nuget.pkg.github.com/${{ env.OWNER }}/index.json"  --api-key ${{ secrets.GITHUB_TOKEN }}